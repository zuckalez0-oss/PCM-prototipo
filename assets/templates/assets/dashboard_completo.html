{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard | LYPSYOS{% endblock %}
{% block page_title %}Visão Geral{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
<style>
    /* Cores Gantt Modernas */
    .gantt-status-aberta .bar {
        fill: #cbd5e1;
    }

    /* Slate 300 */
    .gantt-status-executando .bar {
        fill: #22c55e;
    }

    /* Green 500 */
    .gantt-status-pausada .bar {
        fill: #eab308;
    }

    /* Yellow 500 */
    .gantt-status-finalizada .bar {
        fill: #3b82f6;
    }

    /* Blue 500 */
    .gantt-atrasado .bar {
        fill: #ef4444 !important;
    }

    /* Red 500 */
    .gantt-status-prevista .bar {
        fill: #94a3b8;
        stroke: #64748b;
        stroke-width: 1px;
    }

    /* Slate 400 (Dashed border simulation or lighter color) */
    .gantt .bar-label {
        fill: #334155;
        font-weight: 600;
        font-size: 12px;
        font-family: 'Inter', sans-serif;
    }

    .gantt .bar-progress {
        fill: rgba(0, 0, 0, 0.1);
    }

    .gantt-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    #gantt-target .grid-header {
        fill: #f8fafc;
        stroke: #e2e8f0;
    }

    #gantt-target .grid-row {
        fill: #fff;
    }

    #gantt-target .grid-row:nth-child(even) {
        fill: #f8fafc;
    }
</style>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-full pb-10">

    <!-- Coluna Esquerda: Indicadores e Lista (1/4) -->
    <div class="lg:col-span-1 flex flex-col gap-6">

        <!-- Chart Card -->
        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm relative overflow-hidden">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 border-b border-slate-100 pb-2">
                Indicador de Quebras</h3>
            <div class="h-40">
                <canvas id="chartQuebras"></canvas>
            </div>
            <!-- Decorative circle -->
            <div class="absolute -top-6 -right-6 w-16 h-16 bg-brand-50 rounded-full opacity-50 pointer-events-none">
            </div>
        </div>

        <!-- Agenda Preventiva Card -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col flex-grow overflow-hidden">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Agenda Preventiva</h3>
                <button
                    class="text-xs font-bold text-brand-600 hover:text-brand-700 bg-brand-50 hover:bg-brand-100 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1"
                    data-bs-toggle="modal" data-bs-target="#modalNovoPlano"
                    onclick="new bootstrap.Modal(document.getElementById('modalNovoPlano')).show()">
                    <i class="ph-bold ph-plus"></i> Novo Plano
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-2">
                {% if planos_futuros %}
                <ul class="space-y-1">
                    {% for plano in planos_futuros %}
                    <li
                        class="group flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg transition-all border border-transparent hover:border-slate-100 cursor-pointer">
                        <div>
                            <p class="font-bold text-slate-700 text-sm group-hover:text-brand-600 transition-colors">
                                {{ plano.procedimento_padrao.nome|default:plano.nome }}
                            </p>
                            <p class="text-xs text-slate-400 flex items-center gap-1">
                                <i class="ph ph-gear"></i> [{{ plano.maquina.codigo }}] {{ plano.maquina.nome }}
                            </p>
                        </div>
                        <span class="text-xs font-bold px-2 py-1 rounded-md border 
                            {% if plano.proxima_data <= today %}bg-red-50 text-red-600 border-red-100
                            {% else %}bg-slate-100 text-slate-600 border-slate-200{% endif %}">
                            {{ plano.proxima_data|date:"d/m" }}
                        </span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="h-full flex flex-col items-center justify-center text-slate-400 p-8 text-center">
                    <i class="ph ph-calendar-slash text-4xl mb-2 text-slate-300"></i>
                    <p class="text-sm">Nenhum plano futuro nos próximos dias.</p>
                </div>
                {% endif %}
            </div>
        </div>

    </div>

    <!-- Coluna Direita: Gantt e Controles (3/4) -->
    <div class="lg:col-span-3 flex flex-col bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">

        <!-- Toolbar -->
        <div class="p-4 border-b border-slate-200 bg-slate-50/50 flex flex-wrap gap-4 justify-between items-center">

            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <div class="bg-brand-100 text-brand-600 p-2 rounded-lg">
                        <i class="ph-bold ph-calendar-check text-lg"></i>
                    </div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm">Cronograma Visual</h2>
                        <p class="text-xs text-slate-500 hidden sm:block">Gestão de alocação e tempo</p>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-3">
                <!-- Filtros -->
                <div class="relative group">
                    <i class="ph ph-user absolute left-3 top-2.5 text-slate-400"></i>
                    <select id="filtroTecnico" onchange="aplicarFiltros()"
                        class="pl-9 pr-8 py-2 rounded-lg border border-slate-200 text-sm bg-white focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none shadow-sm cursor-pointer hover:border-slate-300 transition-colors appearance-none">
                        <option value="todos">Todos Técnicos</option>
                        {% for t in tecnicos %}<option value="{{ t.id }}">{{ t.first_name|default:t.username }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="relative group">
                    <i class="ph ph-funnel absolute left-3 top-2.5 text-slate-400"></i>
                    <select id="filtroStatus" onchange="aplicarFiltros()"
                        class="pl-9 pr-8 py-2 rounded-lg border border-slate-200 text-sm bg-white focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none shadow-sm cursor-pointer hover:border-slate-300 transition-colors appearance-none">
                        <option value="todos">Todos Status</option>
                        <option value="aberta">Abertas</option>
                        <option value="executando">Executando</option>
                        <option value="pausada">Pausadas</option>
                        <option value="finalizada">Concluídas</option>
                    </select>
                </div>

                <!-- View Switcher -->
                <div class="flex bg-slate-200/50 p-1 rounded-lg border border-slate-200">
                    <button
                        class="px-3 py-1.5 text-xs font-medium rounded-md text-slate-600 hover:text-slate-900 hover:bg-white/80 transition-all"
                        onclick="changeView('Day')">Dia</button>
                    <button
                        class="px-3 py-1.5 text-xs font-medium rounded-md text-slate-600 hover:text-slate-900 hover:bg-white/80 transition-all"
                        onclick="changeView('Week')">Sem</button>
                    <button
                        class="px-3 py-1.5 text-xs font-medium rounded-md text-slate-600 hover:text-slate-900 hover:bg-white/80 transition-all"
                        onclick="changeView('Month')">Mês</button>
                </div>
            </div>

        </div>

        <!-- Gantt Area -->
        <div class="flex-grow bg-slate-50 relative overflow-hidden flex flex-col">
            <div id="gantt-chart-wrapper" class="w-full h-full overflow-auto p-4 custom-scrollbar">
                <!-- Skeleton Loader -->
                <div id="gantt-skeleton" class="w-full h-full animate-pulse flex flex-col gap-4 p-4">
                    <div class="h-8 bg-slate-200 rounded w-1/4"></div>
                    <div class="h-24 bg-slate-200 rounded"></div>
                    <div class="h-24 bg-slate-200 rounded"></div>
                    <div class="h-24 bg-slate-200 rounded opacity-50"></div>
                </div>
                <svg id="gantt-target" class="hidden d-none"></svg>
            </div>
        </div>

    </div>

</div>
{% endblock %}

{% block modals %}
<!-- Modal Novo Plano -->
<div class="modal fade" id="modalNovoPlano" tabindex="-1" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-2xl rounded-2xl overflow-hidden">
            <div class="modal-header bg-slate-900 text-white p-4 border-0 flex justify-between items-center">
                <div>
                    <h6 class="modal-title font-bold text-lg">Novo Plano Preventivo</h6>
                    <p class="text-xs text-slate-400">Configure a recorrência automática</p>
                </div>
                <button type="button" class="text-slate-400 hover:text-white transition-colors"
                    data-bs-dismiss="modal"><i class="ph ph-x text-xl"></i></button>
            </div>
            <form method="post" class="flex flex-col">
                {% csrf_token %}
                <div class="modal-body p-6 space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nome do Plano</label>
                        {{ form_plano.nome }}
                        <!-- Nota: Assumindo que o form renderiza input padrão, classes seriam ideais no form django ou via JS, 
                             mas o CSS global do Tailwind reseta. Vamos estilizar via JS ou wrapper se necessário. -->
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Máquina</label>
                            {{ form_plano.maquina }}
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Procedimento</label>
                            {{ form_plano.procedimento_padrao }}
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Frequência
                                (Dias)</label>
                            {{ form_plano.frequencia_dias }}
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Data Início</label>
                            {{ form_plano.proxima_data }}
                        </div>
                    </div>
                </div>
                <div class="modal-footer p-4 bg-slate-50 border-t border-slate-100">
                    <button type="button"
                        class="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 transition-colors"
                        data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" name="btn_novo_plano"
                        class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white text-sm font-bold rounded-lg shadow-md shadow-brand-500/20 transition-all">Salvar
                        Plano</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Nova Atividade (OS) -->
<!-- Usando Bootstrap Modal por compatibilidade rápida, mas estilizado -->
<div class="modal fade" id="modalNovaAtividade" tabindex="-1" style="display: none;">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-2xl rounded-2xl">
            <div class="modal-header bg-brand-600 text-white p-5 border-0 flex justify-between items-center">
                <div>
                    <h6 class="modal-title font-bold text-lg">Nova Ordem de Serviço</h6>
                    <p class="text-xs text-brand-100">Preencha os dados da manutenção</p>
                </div>
                <button type="button" class="text-brand-200 hover:text-white transition-colors"
                    data-bs-dismiss="modal"><i class="ph ph-x text-xl"></i></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    {{ form_atividade.as_p }}
                </div>
                <div class="modal-footer p-4 bg-slate-50 border-t border-slate-100">
                    <button type="button"
                        class="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 transition-colors"
                        data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" name="btn_nova_atividade"
                        class="px-6 py-2 bg-brand-600 hover:bg-brand-700 text-white text-sm font-bold rounded-lg shadow-md shadow-brand-500/20 transition-all">Emitir
                        OS</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Detalhes Gantt -->
<div class="modal fade" id="modalDetalhesGantt" tabindex="-1" style="display: none;">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-2xl rounded-2xl overflow-hidden">
            <div class="modal-header p-5 border-b border-slate-100 bg-white flex justify-between items-start">
                <div class="flex items-center gap-4">
                    <div
                        class="w-12 h-12 rounded-xl bg-brand-50 flex items-center justify-center text-brand-600 shadow-sm border border-brand-100">
                        <i class="ph-bold ph-magnifying-glass-plus text-2xl"></i>
                    </div>
                    <div>
                        <h6 class="modal-title font-bold text-xl text-slate-800" id="detalheTitulo">Detalhes</h6>
                        <div class="text-sm text-brand-500 font-medium flex items-center gap-1 mt-0.5">
                            <i class="ph-bold ph-engine"></i>
                            <span id="detalheMaquina">-</span>
                        </div>
                    </div>
                </div>
                <button type="button"
                    class="text-slate-400 hover:text-red-500 transition-colors bg-slate-50 hover:bg-red-50 p-2 rounded-full"
                    data-bs-dismiss="modal"><i class="ph-bold ph-x"></i></button>
            </div>
            <div class="modal-body p-0">
                <div class="grid grid-cols-1 md:grid-cols-5 h-[450px]">
                    <!-- Info -->
                    <div class="col-span-3 p-6 space-y-6 overflow-y-auto">
                        <!-- Prazos e Duração -->
                        <div class="grid grid-cols-3 gap-3">
                            <div class="p-3 bg-slate-50 border border-slate-100 rounded-xl">
                                <label
                                    class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Início</label>
                                <div id="detalheInicio" class="text-xs font-bold text-slate-700">-</div>
                            </div>
                            <div class="p-3 bg-slate-50 border border-slate-100 rounded-xl">
                                <label
                                    class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Fim</label>
                                <div id="detalheFim" class="text-xs font-bold text-slate-700">-</div>
                            </div>
                            <div class="p-3 bg-brand-50 border border-brand-100 rounded-xl">
                                <label
                                    class="text-[10px] font-bold text-brand-400 uppercase tracking-widest block mb-1 text-center">Duração</label>
                                <div id="detalheDuracao" class="text-xs font-bold text-brand-700 text-center">-</div>
                            </div>
                        </div>

                        <div>
                            <label
                                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-2">Descrição
                                do Problema</label>
                            <p id="detalheDescricao"
                                class="text-slate-700 text-sm leading-relaxed bg-slate-50 p-4 rounded-xl border border-slate-100 italic shadow-sm">
                                -</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-2 text-center">Status
                                    Atual</label>
                                <div id="detalheStatus" class="flex justify-center">-</div>
                            </div>
                            <div>
                                <label
                                    class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-2">Responsáveis</label>
                                <div id="detalheTecnicos"
                                    class="text-sm font-semibold text-slate-700 bg-white p-2 rounded-lg border border-slate-100 shadow-sm flex items-center gap-2">
                                    <i class="ph-fill ph-users text-slate-400"></i>
                                    <span>-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Novo: Tempo Total de Pausa -->
                        <div id="containerPausa"
                            class="hidden d-none p-3 bg-amber-50 border border-amber-100 rounded-xl flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="ph-bold ph-timer text-amber-600"></i>
                                <span class="text-xs font-bold text-amber-800 uppercase tracking-wider">Tempo Total de
                                    Pausa</span>
                            </div>
                            <div id="detalheTempoPausa" class="text-sm font-bold text-amber-900">-</div>
                        </div>
                    </div>

                    <!-- Timeline -->
                    <div class="col-span-2 bg-slate-50 border-l border-slate-200 p-5 overflow-y-auto">
                        <h6
                            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <i class="ph-bold ph-clock-counter-clockwise text-brand-500"></i> Log de Atividades
                        </h6>
                        <div id="timelineContainer" class="space-y-4"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer p-4 bg-white border-t border-slate-100 justify-end">
                <button type="button"
                    class="px-5 py-2 bg-slate-800 hover:bg-slate-900 text-white text-sm font-bold rounded-xl shadow-lg shadow-slate-900/10 transition-all flex items-center gap-2"
                    data-bs-dismiss="modal">
                    <i class="ph-bold ph-check-circle"></i> Entendi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Helper button to trigger modal from JS if needed (hidden) -->
<button id="btnNovaAtividade" class="d-none hidden" data-bs-toggle="modal"
    data-bs-target="#modalNovaAtividade"></button>

{% endblock %}

{% block extra_scripts %}
<!-- Dados para JS -->
{{ labels_quebra|json_script:"dados-labels" }}
{{ data_quebra|json_script:"dados-valores" }}

<!-- Third Party Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Bootstrap Bundle (JS only for Modals compatibility, heavily reduced if possible later) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Styling Inputs globally for this page since we are using Django Forms standard render
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll('input, select, textarea').forEach(el => {
            if (!el.classList.contains('form-control') && !el.classList.contains('form-select')) {
                el.classList.add('w-full', 'px-3', 'py-2', 'bg-white', 'border', 'border-slate-200', 'rounded-lg', 'text-sm', 'focus:outline-none', 'focus:ring-2', 'focus:ring-brand-500/20', 'focus:border-brand-500', 'transition-all');
            }
        });
    });

    // Chart.js Configuration
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('chartQuebras').getContext('2d');
        const labels = JSON.parse(document.getElementById('dados-labels').textContent);
        const data = JSON.parse(document.getElementById('dados-valores').textContent);

        if (labels && labels.length > 0) {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: '#0ea5e9',
                        borderRadius: 6,
                        barThickness: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { display: true, drawBorder: false, color: '#f1f5f9' },
                            ticks: { stepSize: 1, font: { size: 10, family: "'Inter', sans-serif" }, color: '#94a3b8' },
                            border: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10, family: "'Inter', sans-serif" }, color: '#64748b' }
                        }
                    }
                }
            });
        }
    });

    // Gantt Logic
    let gantt_chart; let todasTarefas = [];

    async function initGantt() {
        try {
            // In a real scenario, remove the hardcoded fallback if API fails
            const res = await fetch('/api/gantt/dados/');
            todasTarefas = await res.json();
            aplicarFiltros();
        } catch (err) {
            console.error("Erro ao carregar Gantt:", err);
            document.getElementById('gantt-chart-wrapper').innerHTML =
                `<div class="flex flex-col items-center justify-center h-full text-slate-400">
                    <i class="ph ph-warning-circle text-3xl mb-2"></i>
                    <p class="text-sm">Erro ao carregar dados do cronograma.</p>
                </div>`;
        }
    }

    function aplicarFiltros() {
        const filtroTec = document.getElementById('filtroTecnico').value;
        const filtroStat = document.getElementById('filtroStatus').value;

        const tarefasFiltradas = todasTarefas.filter(t => {
            return ((filtroTec === 'todos') || t.tech_ids.includes(filtroTec)) &&
                ((filtroStat === 'todos') || t.status === filtroStat);
        });

        renderGantt(tarefasFiltradas);
    }

    function renderGantt(tasks) {
        const wrapper = document.getElementById('gantt-chart-wrapper');
        const skeleton = document.getElementById('gantt-skeleton');

        // Hide Skeleton
        if (skeleton) skeleton.classList.add('hidden', 'd-none');

        // Reset
        wrapper.innerHTML = '<svg id="gantt-target"></svg>';
        const target = document.getElementById('gantt-target');
        target.classList.remove('hidden', 'd-none');

        if (!tasks || tasks.length === 0) {
            wrapper.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64 text-slate-400">
                    <i class="ph ph-clipboard-text text-3xl mb-2 text-slate-300"></i>
                    <p class="text-sm">Nenhuma tarefa encontrada.</p>
                </div>`;
            return;
        }

        gantt_chart = new Gantt("#gantt-target", tasks, {
            view_mode: 'Day',
            column_width: 30,
            bar_height: 25,
            padding: 18,
            date_format: 'YYYY-MM-DD',
            language: 'ptBr',
            custom_popup_html: null, // Disable default popup
            on_click: task => abrirDetalhes(task)
        });
    }

    function changeView(mode) {
        if (gantt_chart) gantt_chart.change_view_mode(mode);
    }

    function abrirDetalhes(task) {
        document.getElementById('detalheTitulo').innerText = task.full_name;
        document.getElementById('detalheMaquina').innerText = task.maquina;
        document.getElementById('detalheDescricao').innerText = task.description;
        document.getElementById('detalheTecnicos').querySelector('span').innerText = task.tech_names || "Sem técnicos";

        // Novos campos temporais
        document.getElementById('detalheInicio').innerText = task.start_formatted || "-";
        document.getElementById('detalheFim').innerText = task.end_formatted || "-";
        document.getElementById('detalheDuracao').innerText = task.duration || "-";

        // Lógica de Tempo de Pausa
        const containerPausa = document.getElementById('containerPausa');
        if (task.tempo_pausa && task.tempo_pausa > 0) {
            containerPausa.classList.remove('hidden', 'd-none');
            // Formatar segundos para Hh Mm
            const h = Math.floor(task.tempo_pausa / 3600);
            const m = Math.floor((task.tempo_pausa % 3600) / 60);
            document.getElementById('detalheTempoPausa').innerText = `${h}h ${m}m`;
        } else {
            containerPausa.classList.add('hidden', 'd-none');
        }

        // Status Badge Style
        const statusMap = {
            'aberta': 'bg-slate-100 text-slate-600 border-slate-200',
            'executando': 'bg-green-100 text-green-700 border-green-200',
            'pausada': 'bg-amber-100 text-amber-700 border-amber-200',
            'finalizada': 'bg-blue-100 text-blue-700 border-blue-200',
            'Agendada': 'bg-indigo-50 text-indigo-600 border-indigo-100'
        };
        const statusClass = statusMap[task.status] || 'bg-slate-100 text-slate-600 border-slate-200';

        document.getElementById('detalheStatus').innerHTML =
            `<span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border shadow-sm ${statusClass}">${task.status}</span>`;

        const tlContainer = document.getElementById('timelineContainer');
        if (task.logs && task.logs.length > 0) {
            let html = '<div class="relative pl-4 border-l-2 border-slate-200 space-y-6">';
            task.logs.forEach(log => {
                html += `
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-white border-2 border-brand-500 rounded-full"></div>
                        <p class="text-xs text-slate-400 font-semibold mb-1">${log.data} <span class="text-slate-300">•</span> ${log.usuario}</p>
                        <div class="bg-white p-2 rounded border border-slate-200 text-xs text-slate-600 shadow-sm">${log.descricao}</div>
                    </div>`;
            });
            html += '</div>';
            tlContainer.innerHTML = html;
        } else {
            tlContainer.innerHTML = '<p class="text-slate-400 text-xs text-center py-4">Sem registros de histórico.</p>';
        }

        new bootstrap.Modal(document.getElementById('modalDetalhesGantt')).show();
    }

    window.onload = initGantt;
</script>
{% endblock %}