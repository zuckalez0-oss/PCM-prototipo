<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LYPSYOS | PCM Manager</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">

    <style>
        :root { --sidebar-width: 300px; }
        body { background: #f3f4f6; overflow-x: hidden; font-family: 'Inter', sans-serif; }
        .dashboard-wrapper { display: flex; height: 100vh; }

        /* Sidebar */
        .analytics-sidebar {
            width: var(--sidebar-width); background: white; border-right: 1px solid #e5e7eb;
            padding: 20px; overflow-y: auto; flex-shrink: 0; display: flex; flex-direction: column; gap: 2rem; z-index: 100;
        }

        /* Área Principal */
        .gantt-area { flex-grow: 1; padding: 20px; overflow-y: auto; background: #f8fafc; display: flex; flex-direction: column; }
        .gantt-container { background: white; border-radius: 8px; border: 1px solid #e5e7eb; overflow: hidden; min-height: 500px; flex-grow: 1; }
        
        /* CORES DO GANTT */
        .gantt-status-aberta .bar { fill: #94a3b8; }
        .gantt-status-executando .bar { fill: #22c55e; }
        .gantt-status-pausada .bar { fill: #f59e0b; }
        .gantt-status-finalizada .bar { fill: #3b82f6; }
        .gantt-atrasado .bar { fill: #ef4444 !important; stroke: #b91c1c; stroke-width: 2; } /* NOVO: ATRASADO */
        .gantt-emergencial .bar { fill: #dc2626 !important; stroke: #991b1b; stroke-width: 2; }
        
        .chart-box { height: 180px; position: relative; width: 100%; }
        .section-title { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: #64748b; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; margin-bottom: 1rem; }
        .navbar-custom { background-color: #1a202c; color: white; border-radius: 8px; }
        
        /* Filtros Customizados */
        .filter-select { background-color: #334155; color: white; border: 1px solid #475569; font-size: 0.85rem; }
        .filter-select:focus { background-color: #334155; color: white; box-shadow: none; border-color: #0ea5e9; }
    </style>
</head>
<body>

<div class="dashboard-wrapper">
    
    <aside class="analytics-sidebar shadow-sm">
        <div><h5 class="fw-bold text-dark mb-0">LYPSYOS <span class="text-primary">PCM</span></h5><small class="text-muted">Intelligence Module</small></div>

        <div>
            <div class="section-title">Índice de Quebras</div>
            <div class="chart-box"><canvas id="chartQuebras"></canvas></div>
        </div>

        <div>
            <div class="section-title">Próximas Preventivas</div>
            <ul class="list-group list-group-flush small">
                {% for plano in planos_futuros %}
                <li class="list-group-item px-0 border-0 d-flex justify-content-between">
                    <div><div class="fw-bold">{{ plano.nome }}</div><div class="text-muted small">{{ plano.maquina.codigo }}</div></div>
                    <span class="badge bg-light text-dark border">{{ plano.proxima_data|date:"d/m" }}</span>
                </li>
                {% empty %}
                <li class="text-muted small text-center">Nenhum plano agendado.</li>
                {% endfor %}
            </ul>
        </div>
    </aside>

    <main class="gantt-area">
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show py-2 small shadow-sm" role="alert">
                    {{ message }} <button type="button" class="btn-close p-2" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <nav class="navbar-custom mb-3 p-3 shadow-sm d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div class="d-flex align-items-center gap-3">
                <a href="{% url 'lista_atividades' %}" class="btn btn-outline-light btn-sm border-secondary"><i class="fas fa-chevron-left"></i></a>
                <div><h6 class="mb-0 fw-bold">Painel Operacional</h6><small class="opacity-75">VISÃO GERAL</small></div>
            </div>

            <div class="d-flex gap-2 align-items-center">
                <select id="filtroTecnico" class="form-select form-select-sm filter-select" onchange="aplicarFiltros()">
                    <option value="todos">Todos os Técnicos</option>
                    {% for t in tecnicos %}
                        <option value="{{ t.id }}">{{ t.first_name|default:t.username }}</option>
                    {% endfor %}
                </select>

                <select id="filtroStatus" class="form-select form-select-sm filter-select" onchange="aplicarFiltros()">
                    <option value="todos">Todos Status</option>
                    <option value="aberta">Abertas</option>
                    <option value="executando">Em Execução</option>
                    <option value="pausada">Pausadas</option>
                    <option value="finalizada">Concluídas</option>
                </select>

                <div class="vr bg-secondary mx-1"></div>

                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-light border-secondary" onclick="changeView('Day')">Dia</button>
                    <button class="btn btn-sm btn-outline-light border-secondary" onclick="changeView('Week')">Sem</button>
                    <button class="btn btn-sm btn-outline-light border-secondary" onclick="changeView('Month')">Mês</button>
                </div>

                <button class="btn btn-primary btn-sm fw-bold ms-2" data-bs-toggle="modal" data-bs-target="#modalNovaAtividade">
                    <i class="fas fa-plus me-1"></i> Agendar
                </button>
            </div>
        </nav>

        <div class="gantt-container shadow-sm position-relative">
            <svg id="gantt-target"></svg>
            <div id="loading-gantt" class="position-absolute top-50 start-50 translate-middle text-muted" style="display:none;">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div> Carregando...
            </div>
        </div>
    </main>
</div>

<div class="modal fade" id="modalNovaAtividade" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white"><h6 class="modal-title fw-bold">Agendar Nova Atividade</h6><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6"><label class="form-label small fw-bold">Máquina</label>{{ form.maquina }}</div>
                        <div class="col-md-6"><label class="form-label small fw-bold">Início Planejado</label>{{ form.data_planejada }}</div>
                        <div class="col-12"><div class="form-check form-switch bg-light p-3 rounded border">{{ form.eh_preventiva }}<label class="form-check-label ms-2 fw-bold" for="checkPreventiva">É Manutenção Preventiva?</label></div></div>
                        <div id="sectionPreventiva" class="col-12 d-none"><label class="form-label text-primary fw-bold">Procedimento Padrão</label>{{ form.procedimento_base }}</div>
                        <div id="sectionDescricao" class="col-12"><label class="form-label small fw-bold">Descrição</label>{{ form.descricao }}</div>
                        <div class="col-12"><label class="form-label small fw-bold">Técnicos</label>{{ form.colaboradores }}</div>
                        <div id="sectionTempo" class="col-12"><div class="row"><div class="col-6"><label class="form-label small fw-bold">Tempo</label>{{ form.tempo_valor }}</div><div class="col-6"><label class="form-label small fw-bold">Unidade</label>{{ form.tempo_unidade }}</div></div></div>
                    </div>
                </div>
                <div class="modal-footer bg-light"><button type="submit" class="btn btn-primary px-4 fw-bold">Salvar Agendamento</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalhesGantt" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white"><h6 class="modal-title fw-bold" id="detalheTitulo">Detalhes</h6><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-3"><label class="small text-muted fw-bold">MÁQUINA</label><div class="fw-bold fs-5" id="detalheMaquina">-</div></div>
                <div class="mb-3"><label class="small text-muted fw-bold">DESCRIÇÃO</label><p class="mb-0" id="detalheDescricao">-</p></div>
                <div class="row">
                    <div class="col-6"><label class="small text-muted fw-bold">STATUS</label><div id="detalheStatus">-</div></div>
                    <div class="col-6"><label class="small text-muted fw-bold">PROGRESSO</label><div id="detalheProgresso">-</div></div>
                </div>
                <hr>
                <div class="mb-2"><label class="small text-muted fw-bold">EQUIPE</label><div id="detalheTecnicos" class="text-primary">-</div></div>
            </div>
            <div class="modal-footer p-2 bg-light">
                <a href="#" id="btnEditarLink" class="btn btn-outline-primary btn-sm w-100">Gerenciar na Lista</a>
            </div>
        </div>
    </div>
</div>

{{ labels_quebra|json_script:"dados-labels" }}
{{ data_quebra|json_script:"dados-valores" }}

<script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- 1. CONFIGURAÇÃO CHART.JS (Mantido) ---
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('chartQuebras').getContext('2d');
        const labels = JSON.parse(document.getElementById('dados-labels').textContent);
        const data = JSON.parse(document.getElementById('dados-valores').textContent);

        if(labels && labels.length > 0) {
            new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: '#ef4444', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false }, ticks: { stepSize: 1 } }, x: { grid: { display: false } } } }
            });
        }
        
        // Lógica do Form Preventiva (Esconder/Mostrar campos)
        const check = document.getElementById('id_eh_preventiva');
        if(check){
            check.addEventListener('change', function() {
                if(this.checked) {
                    document.getElementById('sectionPreventiva').classList.remove('d-none');
                    document.getElementById('sectionDescricao').classList.add('d-none');
                    document.getElementById('sectionTempo').classList.add('d-none');
                } else {
                    document.getElementById('sectionPreventiva').classList.add('d-none');
                    document.getElementById('sectionDescricao').classList.remove('d-none');
                    document.getElementById('sectionTempo').classList.remove('d-none');
                }
            });
        }
    });

    // --- 2. LÓGICA DO GANTT INTELIGENTE ---
    let gantt_chart;
    let todasTarefas = []; // Armazena todas as tarefas para filtrar localmente

    async function initGantt() {
        try {
            const res = await fetch('/api/gantt/dados/'); 
            todasTarefas = await res.json();
            aplicarFiltros(); // Chama a primeira renderização
        } catch (err) {
            console.error(err);
        }
    }

    function aplicarFiltros() {
        const filtroTec = document.getElementById('filtroTecnico').value;
        const filtroStat = document.getElementById('filtroStatus').value;
        
        // Filtra o Array Original
        const tarefasFiltradas = todasTarefas.filter(t => {
            const matchTec = (filtroTec === 'todos') || t.tech_ids.includes(filtroTec);
            const matchStat = (filtroStat === 'todos') || t.status === filtroStat;
            return matchTec && matchStat;
        });

        renderGantt(tarefasFiltradas);
    }

    function renderGantt(tasks) {
        const container = document.querySelector('.gantt-container');
        document.getElementById('gantt-target').innerHTML = ''; // Limpa anterior

        if (!tasks || tasks.length === 0) {
            container.innerHTML = "<div class='d-flex justify-content-center align-items-center h-100 text-muted'>Nenhuma tarefa encontrada com esses filtros.</div><svg id='gantt-target'></svg>";
            return;
        } else {
            // Restaura o SVG se tiver sido removido
            if(!document.getElementById('gantt-target')) container.innerHTML = "<svg id='gantt-target'></svg>";
        }

        gantt_chart = new Gantt("#gantt-target", tasks, {
            view_mode: 'Day',
            column_width: 30,
            bar_height: 25,
            padding: 18,
            date_format: 'YYYY-MM-DD',
            language: 'ptBr',
            
            // AÇÃO DE CLIQUE: ABRE O MODAL
            on_click: task => {
                document.getElementById('detalheTitulo').innerText = task.full_name;
                document.getElementById('detalheMaquina').innerText = task.maquina;
                document.getElementById('detalheDescricao').innerText = task.description;
                document.getElementById('detalheTecnicos').innerText = task.tech_names || "Sem técnicos atribuídos";
                document.getElementById('detalheStatus').innerHTML = `<span class="badge bg-secondary text-uppercase">${task.status}</span>`;
                document.getElementById('detalheProgresso').innerText = task.progress + "%";
                
                // Link para ir pra lista e editar
                // Precisamos de uma URL baseada no ID, aqui mandamos para a lista geral por enquanto
                // Idealmente você criaria uma URL específica para editar, mas a lista serve
                
                const modal = new bootstrap.Modal(document.getElementById('modalDetalhesGantt'));
                modal.show();
            },
            
            on_date_change: (task, start, end) => {
                console.log("Mudou data (Futuro AJAX):", start, end);
            }
        });
    }

    function changeView(mode) {
        if(gantt_chart) gantt_chart.change_view_mode(mode);
    }

    window.onload = initGantt;
</script>

</body>
</html>