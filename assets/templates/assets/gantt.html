{% extends 'base.html' %}
{% load static %}

{% block title %}PCM | Cronograma Visual{% endblock %}
{% block page_title %}Planejamento Visível{% endblock %}

{% block extra_head %}
<!-- Frappe Gantt CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
<style>
    .gantt-status-aberta .bar {
        fill: #a1a1aa;
    }

    .gantt-status-executando .bar {
        fill: #22c55e;
    }

    .gantt-status-pausada .bar {
        fill: #f59e0b;
    }

    .gantt-status-finalizada .bar {
        fill: #3b82f6;
    }

    .gantt-container {
        background: white;
        border-radius: 12px;
        overflow: auto;
        min-height: 600px;
        box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
    }

    .gantt-emergencial .bar {
        fill: #ef4444 !important;
        stroke: #b91c1c;
        stroke-width: 2;
    }

    .gantt-atrasado .bar {
        fill: #7c2d12 !important;
        /* Cinnamon brown */
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header de Ações -->
    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-brand-50 text-brand-600 rounded-lg">
                <i class="ph-bold ph-calendar-check text-xl"></i>
            </div>
            <div>
                <h2 class="text-sm font-bold text-slate-800">Linha do Tempo Industrial</h2>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Controle de Ocupação e Prazos
                </p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <!-- Toggle Concluídas -->
            <label
                class="flex items-center gap-2 cursor-pointer bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200">
                <input type="checkbox" id="check-show-all" onchange="initGantt()" class="form-check-input">
                <span class="text-[10px] font-black uppercase text-slate-500">Ver Concluídas</span>
            </label>

            <div class="btn-group bg-slate-100 p-1 rounded-lg border border-slate-200 flex">
                <button
                    class="px-3 py-1 text-[10px] font-black uppercase rounded-md hover:bg-white hover:text-brand-600 transition-all border border-transparent hover:border-slate-200"
                    onclick="changeView('Quarter Day')">6h</button>
                <button
                    class="px-3 py-1 text-[10px] font-black uppercase rounded-md hover:bg-white hover:text-brand-600 transition-all border border-transparent hover:border-slate-200"
                    onclick="changeView('Half Day')">12h</button>
                <button
                    class="px-3 py-1 text-[10px] font-black uppercase rounded-md hover:bg-white hover:text-brand-600 transition-all border border-transparent hover:border-slate-200"
                    onclick="changeView('Day')">Dia</button>
                <button
                    class="px-3 py-1 text-[10px] font-black uppercase rounded-md hover:bg-white hover:text-brand-600 transition-all border border-transparent hover:border-slate-200"
                    onclick="changeView('Week')">Sem</button>
            </div>

            <button onclick="initGantt()" class="p-2 text-slate-400 hover:text-brand-600 transition-all">
                <i class="ph-bold ph-arrows-clockwise text-lg"></i>
            </button>
        </div>
    </div>

    <!-- Gráfico -->
    <div class="bg-white p-2 rounded-2xl border border-slate-200 shadow-xl overflow-hidden">
        <div class="gantt-container border border-slate-100 rounded-xl" id="gantt-wrapper">
            <svg id="gantt-target"></svg>
        </div>
    </div>

    <!-- Legenda -->
    <div
        class="flex items-center gap-6 px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest text-slate-400">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded bg-slate-400"></div> Aberta
        </div>
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded bg-green-500"></div> Execução
        </div>
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded bg-amber-500"></div> Pausada
        </div>
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded bg-blue-500"></div> Concluída
        </div>
        <div class="flex items-center gap-2">
            <div class="w-1.5 h-3 rounded bg-red-600"></div> Atrasada
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Snap.svg & Moment required by Frappe Gantt -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>

<script>
    let gantt_chart;

    async function initGantt() {
        const wrapper = document.getElementById('gantt-wrapper');
        const showAll = document.getElementById('check-show-all').checked;

        try {
            const res = await fetch(`/api/gantt/dados/?all=${showAll}`);
            const tasks = await res.json();

            // Limpa o SVG e o wrapper se necessário
            document.getElementById('gantt-target').innerHTML = '';

            if (tasks.length === 0) {
                document.getElementById('gantt-target').style.height = '0px';
                wrapper.innerHTML = `
                    <div class='p-20 text-center flex flex-col items-center gap-4' id='gantt-empty'>
                        <i class="ph ph-tray text-6xl text-slate-200"></i>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest italic">Nenhuma tarefa ativa encontrada</p>
                    </div>`;
                return;
            }

            // Remove aviso de vazio se existir
            const emptyMsg = document.getElementById('gantt-empty');
            if (emptyMsg) emptyMsg.remove();

            gantt_chart = new Gantt("#gantt-target", tasks, {
                view_mode: 'Half Day', // Maior resolução por padrão
                column_width: 80,      // Colunas mais largas para ver as barras
                bar_height: 25,
                padding: 15,
                language: 'pt-br',
                custom_popup_html: function (task) {
                    return `
                        <div class="bg-white p-4 rounded-lg shadow-xl border border-slate-200 min-w-[200px]">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[10px] font-black uppercase text-brand-600">${task.status}</span>
                                <span class="text-[9px] text-slate-400 font-mono">ID #${task.id}</span>
                            </div>
                            <h4 class="text-xs font-bold text-slate-800 mb-2">${task.name}</h4>
                            <div class="space-y-1 text-[10px] text-slate-500 font-medium">
                                <p><i class="ph-bold ph-engine mr-1"></i> ${task.maquina}</p>
                                <p><i class="ph-bold ph-user-circle mr-1"></i> ${task.tecnicos}</p>
                                <p><i class="ph-bold ph-clock mr-1"></i> ${moment(task.start).format('DD/MM HH:mm')} - ${moment(task.end).format('HH:mm')}</p>
                            </div>
                        </div>
                    `;
                }
            });
        } catch (err) {
            console.error("Erro no Gantt:", err);
            wrapper.innerHTML = "<div class='p-10 text-center text-red-500 font-bold'>Erro ao processar o cronograma.</div>";
        }
    }

    function changeView(mode) {
        if (gantt_chart) gantt_chart.change_view_mode(mode);
    }

    // Inicializa ao carregar
    document.addEventListener('DOMContentLoaded', initGantt);
</script>
{% endblock %}